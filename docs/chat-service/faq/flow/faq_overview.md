# FAQ 시스템 전체 흐름 개요

## 📋 전체 플로우

```
[초기 단계]
초기 데이터 (Flyway 마이그레이션)
  ↓
프론트 챗봇 화면에 FAQ 표시
  ↓
[운영 단계]
사용자 질문 로그 수집
  ↓
AI가 후보 선정 및 초안 생성
  ↓
관리자 승인 → FAQ 추가
  ↓
필요시 관리자가 수동으로 FAQ 추가
```

---

## 🔍 단계별 상세 설명

### 1️⃣ 초기 데이터 (Flyway 마이그레이션)

**언제**: 서비스 최초 시작 시 (DB 마이그레이션 실행)

**무엇을**: 기본 FAQ 데이터 9개 자동 삽입
- SECURITY 도메인: 3개 (비밀번호 재설정, 계정 잠금, 보안 인증)
- POLICY 도메인: 3개 (휴가 신청, 연차 지급, 출근 시간)
- EDUCATION 도메인: 3개 (필수 교육, 교육 이수 확인, 수료증 발급)

**결과**: 
- FAQ 테이블에 데이터 저장
- `isActive: true` → 즉시 사용자에게 노출 가능
- 프론트 챗봇 화면에 표시됨

**코드 위치**: 
- `chat-service/src/main/resources/db/migration/V14__insert_initial_faq_data.sql`

---

### 2️⃣ 프론트 챗봇 화면에 FAQ 표시

**언제**: 사용자가 챗봇 화면 접속 시

**무엇을**: 활성화된 FAQ 목록 조회 및 표시

**API**:
- `GET /chat/faq` → 활성화된 FAQ 전체 조회 (우선순위 순)
- `GET /faq/home` → 홈 화면용 FAQ (도메인별 1개씩)
- `GET /faq?domain={domain}` → 도메인별 TOP 10 FAQ

**결과**: 
- 프론트엔드에서 FAQ 카드로 표시
- 사용자가 FAQ 클릭 시 질문이 자동으로 입력창에 채워짐

---

### 3️⃣ 사용자 질문 로그 수집

**언제**: 사용자가 챗봇에 질문할 때마다

**무엇을**: 사용자 질문을 데이터베이스에 저장

**저장 위치**: 
- `chat.chat_message` 테이블
- `role = 'user'`인 메시지들
- 필드: `content` (질문 내용), `keyword` (키워드), `created_at` (질문 시각), `domain` (도메인)

**결과**: 
- 질문 로그가 계속 쌓임
- 나중에 AI가 분석할 데이터 준비

**코드 위치**:
- `ChatMessageServiceImpl.sendMessage()` → 사용자 메시지 저장

---

### 4️⃣ AI가 후보 선정 및 초안 생성

**언제**: 관리자가 주기적으로 실행 (예: 주 1회)

**무엇을**: 질문 로그를 분석하여 자주 묻는 질문을 찾고 FAQ 초안 생성

**프로세스**:

#### 4-1. 자동 FAQ 생성 요청
```
관리자
  ↓
POST /admin/faq/candidates/auto-generate
{
  "domain": "SECURITY",
  "minFrequency": 3,      // 최소 3회 이상 질문된 것만
  "daysBack": 30,        // 최근 30일 데이터
  "maxCandidates": 20,    // 최대 20개 후보
  "autoGenerateDrafts": true  // 자동으로 초안까지 생성
}
```

#### 4-2. AI 서버 분석
```
AI 서버
  ↓
질문 로그 분석
  - 빈도 분석 (7일간, 30일간 질문 횟수)
  - 의도 신뢰도 분석
  - PII(개인정보) 감지
  - 후보 점수 계산
  ↓
FaqCandidate 생성
  - status: ELIGIBLE (Draft 생성 가능)
  - status: EXCLUDED (PII 있거나 신뢰도 부족)
```

#### 4-3. AI 초안 생성
```
AI 서버
  ↓
RAGFlow 호출 (관련 문서 검색)
  ↓
LLM으로 FAQ 초안 생성
  ↓
FaqDraft 생성
  - status: DRAFT
  - question, answer, summary
```

**결과**: 
- `faq_candidate` 테이블에 후보 저장
- `faq_drafts` 테이블에 초안 저장
- 관리자가 검토할 수 있는 상태

**코드 위치**:
- `FaqServiceImpl.generateAuto()` → 자동 FAQ 생성
- `FaqServiceImpl.generateDraftFromCandidate()` → 후보에서 초안 생성

---

### 5️⃣ 관리자 승인 → FAQ 추가

**언제**: 관리자가 Draft 목록을 확인하고 승인할 때

**무엇을**: AI가 생성한 FAQ 초안을 검토하고 승인/반려

**프로세스**:

#### 5-1. Draft 목록 조회
```
관리자
  ↓
GET /admin/faq/drafts
  → Draft 목록 확인
```

#### 5-2. 승인 또는 반려
```
[승인 시]
POST /admin/faq/drafts/{draftId}/approve
  ?reviewerId={관리자ID}
  &question={질문}
  &answer={답변}
  ↓
FAQ 테이블에 저장
  - isActive: true
  - publishedAt: now()
  ↓
프론트 챗봇 화면에 즉시 표시됨

[반려 시]
POST /admin/faq/drafts/{draftId}/reject
  ?reviewerId={관리자ID}
  &reason={반려사유}
  ↓
FaqDraft 상태 변경
  - status: REJECTED
```

**결과**: 
- 승인된 FAQ는 즉시 사용자에게 노출
- 반려된 Draft는 이력에 기록

**코드 위치**:
- `FaqServiceImpl.approveDraft()` → Draft 승인
- `FaqServiceImpl.rejectDraft()` → Draft 반려

---

### 6️⃣ 필요시 관리자가 수동으로 FAQ 추가

**언제**: 긴급하게 FAQ를 추가해야 하거나, AI가 놓친 중요한 질문이 있을 때

**무엇을**: 관리자가 직접 FAQ 생성

**프로세스**:
```
관리자
  ↓
POST /chat/faq
{
  "question": "추가할 질문",
  "answer": "답변 내용",
  "domain": "SECURITY",
  "priority": 1
}
  ↓
FAQ 테이블에 즉시 저장
  - isActive: true
  - publishedAt: now()
  ↓
프론트 챗봇 화면에 즉시 표시됨
```

**결과**: 
- AI 초안 생성 과정 없이 바로 FAQ 추가
- 즉시 사용자에게 노출

**코드 위치**:
- `FaqController.create()` → FAQ 수동 생성
- `FaqServiceImpl.create()` → FAQ 저장

---

## 🔄 전체 사이클 요약

```
[서비스 시작]
초기 데이터 삽입 (9개 FAQ)
  ↓
[일상 운영]
사용자 질문 → 로그 수집
  ↓
[주기적 실행 - 예: 주 1회]
AI 분석 → 후보 선정 → 초안 생성
  ↓
[관리자 검토]
Draft 승인/반려
  ↓
[승인 시]
FAQ 추가 → 사용자에게 노출
  ↓
[필요시]
관리자 수동 FAQ 추가
```

---

## 📊 데이터 흐름 다이어그램

```
┌─────────────────────────────────────────────────────────┐
│                    FAQ 시스템 데이터 흐름                  │
└─────────────────────────────────────────────────────────┘

[초기]
Flyway 마이그레이션
  → chat.faq (9개 데이터)
  → isActive: true
  → 프론트 표시

[운영]
사용자 질문
  → chat.chat_message (로그 저장)
  ↓
AI 분석 (주기적)
  → chat.faq_candidate (후보)
  → chat.faq_drafts (초안)
  ↓
관리자 승인
  → chat.faq (FAQ 추가)
  → isActive: true
  → 프론트 표시

[수동]
관리자 직접 생성
  → chat.faq (FAQ 추가)
  → isActive: true
  → 프론트 표시
```

---

## 🎯 주요 포인트

1. **초기 데이터**: 서비스 시작 시 기본 FAQ 9개 자동 삽입
2. **자동화**: 질문 로그 기반으로 AI가 자동으로 FAQ 후보 선정 및 초안 생성
3. **품질 관리**: 모든 AI 초안은 관리자 승인 필수
4. **유연성**: 필요시 관리자가 수동으로 FAQ 추가 가능
5. **즉시 반영**: 승인된 FAQ는 즉시 사용자에게 노출

---

## 📝 관련 파일 위치

- **초기 데이터**: `chat-service/src/main/resources/db/migration/V14__insert_initial_faq_data.sql`
- **FAQ 조회 API**: `chat-service/src/main/java/com/ctrlf/chat/faq/controller/FaqController.java`
- **FAQ 수동 생성**: `FaqController.create()`
- **자동 FAQ 생성**: `FaqServiceImpl.generateAuto()`
- **Draft 승인**: `FaqServiceImpl.approveDraft()`

