server:
  port: 8085
  # Docker/외부(컨테이너)에서 host.docker.internal 로 접근할 수 있도록 바인딩 주소를 명시
  address: 0.0.0.0

spring:
  application:
    name: api-gateway

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8090/realms/ctrlf

  cloud:
    # Spring Boot 3.2.13과 Spring Cloud 2023.0.4 호환
    compatibility-verifier:
      enabled: false
    gateway:
      # ForwardedHeadersFilter 비활성화 (로컬 개발 환경에서는 불필요)
      forwarded:
        enabled: false
      routes:
        # ============================================================
        # Public API Routes (인증 필요)
        # ============================================================
        # 주의: 더 구체적인 경로를 먼저 정의해야 함 (Spring Cloud Gateway는 순서대로 매칭)

        # ============================================================
        # Chat Service (9005)
        # ============================================================
        # /admin/dashboard/chat는 가장 구체적인 경로이므로 먼저 정의
        - id: chat-admin-dashboard-route
          uri: http://localhost:9005
          predicates:
            - Path=/admin/dashboard/chat/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /api/chat 경로
        - id: chat-api-route
          uri: http://localhost:9005
          predicates:
            - Path=/api/chat/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /chat 경로
        - id: chat-route
          uri: http://localhost:9005
          predicates:
            - Path=/chat/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

        # ============================================================
        # Education Service (9002)
        # ============================================================
        # /admin/dashboard/education는 가장 구체적인 경로이므로 먼저 정의
        - id: education-admin-dashboard-route
          uri: http://localhost:9002
          predicates:
            - Path=/admin/dashboard/education/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /admin/edus 경로
        - id: education-admin-edus-route
          uri: http://localhost:9002
          predicates:
            - Path=/admin/edus/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /admin/edu 경로
        - id: education-admin-edu-route
          uri: http://localhost:9002
          predicates:
            - Path=/admin/edu/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /edus 경로
        - id: education-edus-route
          uri: http://localhost:9002
          predicates:
            - Path=/edus/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /edu 경로
        - id: education-edu-route
          uri: http://localhost:9002
          predicates:
            - Path=/edu/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /video 경로
        - id: education-video-route
          uri: http://localhost:9002
          predicates:
            - Path=/video/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

        # ============================================================
        # Infra Service (9003)
        # ============================================================
        # /api/ai-logs 경로 (가장 구체적인 경로이므로 먼저 정의)
        - id: infra-api-ai-logs-route
          uri: http://localhost:9003
          predicates:
            - Path=/api/ai-logs/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /api/personalization 경로 (AI Gateway → Backend 개인화 API)
        - id: infra-api-personalization-route
          uri: http://localhost:9003
          predicates:
            - Path=/api/personalization/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /internal/ai/logs 경로 (AI → Backend AI 로그 수집)
        - id: infra-internal-ai-logs-route
          uri: http://localhost:9003
          predicates:
            - Path=/internal/ai/logs/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /internal/telemetry 경로 (AI → Backend 텔레메트리 수집)
        - id: infra-internal-telemetry-route
          uri: http://localhost:9003
          predicates:
            - Path=/internal/telemetry/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /internal/rag/documents는 가장 구체적인 경로이므로 먼저 정의
        - id: infra-internal-rag-documents-route
          uri: http://localhost:9003
          predicates:
            - Path=/internal/rag/documents/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /internal/rag 경로
        - id: infra-internal-rag-route
          uri: http://localhost:9003
          predicates:
            - Path=/internal/rag/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /rag/documents 경로
        - id: infra-rag-documents-route
          uri: http://localhost:9003
          predicates:
            - Path=/rag/documents/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /infra/files/presign 경로
        - id: infra-files-presign-route
          uri: http://localhost:9003
          predicates:
            - Path=/infra/files/presign/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # /admin/users 경로
        - id: infra-admin-users-route
          uri: http://localhost:9003
          predicates:
            - Path=/admin/users/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달
        # 나머지 /admin/**는 infra-service로 라우팅 (가장 마지막에 정의)
        - id: infra-admin-route
          uri: http://localhost:9003
          predicates:
            - Path=/admin/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

        # ============================================================
        # Quiz Service (9004)
        # ============================================================
        - id: quiz-route
          uri: http://localhost:9004
          predicates:
            - Path=/api/quiz/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

        # ============================================================
        # Keycloak Service (8090)
        # ============================================================
        - id: keycloak-auth-route
          uri: http://localhost:8090
          predicates:
            - Path=/auth/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

        # ============================================================
        # Internal API Routes (내부 서비스 간 통신, 인증 우회)
        # ============================================================
        # Source set 관련 (education-service)
        - id: internal-source-sets-route
          uri: http://localhost:9002
          predicates:
            - Path=/internal/source-sets/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

        # Source set 콜백 (education-service)
        - id: internal-callbacks-route
          uri: http://localhost:9002
          predicates:
            - Path=/internal/callbacks/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

        # 스크립트 관련 (education-service)
        - id: internal-scripts-route
          uri: http://localhost:9002
          predicates:
            - Path=/internal/scripts/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

        # 영상 생성 콜백 (education-service)
        - id: internal-video-route
          uri: http://localhost:9002
          predicates:
            - Path=/internal/video/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

        # Storage presign/complete (education-service)
        - id: internal-storage-route
          uri: http://localhost:9002
          predicates:
            - Path=/internal/storage/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

        # Chat 서비스 내부 API (chat-service)
        - id: internal-chat-route
          uri: http://localhost:9005
          predicates:
            - Path=/internal/chat/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

        # AI 서버로의 요청 (백엔드 → AI 서버)
        - id: internal-ai-route
          uri: http://localhost:8000
          predicates:
            - Path=/internal/ai/**
          filters:
            - StripPrefix=0 # 경로 그대로 전달

      globalcors:
        add-to-simple-url-handler-mapping: true
        corsConfigurations:
          "[/**]":
            allowedOrigins:
              - http://localhost:5173
              - http://localhost:3000
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: true

management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      probes:
        enabled: true

# 로깅 설정 (운영 관점)
logging:
  charset:
    console: UTF-8
  file:
    charset: UTF-8
    name: logs/api-gateway.log
    max-size: 100MB
    max-history: 30
    total-size-cap: 3GB
  level:
    root: INFO
    com.ctrlf.gateway.filter: INFO
    org.springframework.cloud.gateway: INFO
    org.springframework.web.server.handler: INFO
    org.springframework.web.reactive.function.client: INFO
    org.springframework.cloud.gateway.filter.headers: WARN
    org.springframework.cloud.gateway.filter.handler: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"